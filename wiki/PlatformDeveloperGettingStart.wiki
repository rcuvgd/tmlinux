#labels Featured
<wiki:toc max_depth="3" />

= Introduction =

This page describes how to compile the whole platform of tmlinux (includding linux kernel, uclibc and so on) and how to populate sysroot for application developer.

= Details =

==Preparation==
===0. Environment setup==
In the following section, let's suppose:<br>
 # the workdir is _*/home/guohr/worktest*_;
 # the TCS installation directory is _*/opt/NXP/TCS520*_;
 # the NDK installation directory is _*/opt/NXP/NDK6.0/*_;
 
===1. Get and Install TCS Linux edition===
First of all, you should install TCS Linux edition on your Linux machines. Please goto [http://www.tcshelp.com] to get it. Of course, you should have the license for it. 
In the following section, let's suppose the installation directory of your TCS is _*/opt/NXP/TCS520/*_

*Note that*<br>
To run tmlinux on mbe1500 board or pnx1500 simulator, you need TCS 5.10 or above; to run tmlinux on pnx1005 simulator, you need TCS 5.20 or above.

To make sure the TCS tools(such as tmcc, tmld) are in the PATH environment
  {{{
export PATH=$PATH:/opt/NXP/TCS520/bin/
  }}}
  {{{
guohr@ghr-notebook-02:~/worktest> tmcc -V
tmcc: V7.1.0 of TCS V5.1(0042rc6_Linux)
tmcc warning : no work
  }}}

===2. Get and install NDK edition===
Then, you should install NDK on your windows machine. And then pack the whole NDK directory and copy it to your linux machine (work machine of tmlinux). On your linux machine, unpack it to _*/opt/NXP/NDK6.0*_. <br>
If you don't have NDK, please goto [http://www.tcshelp.com] to get it. 

*Note that*<br>
To run tmlinux on mbe1500 board or pnx1500 simulator, you need NDK 5.8 or above; to run tmlinux on pnx1005 simulator, you need NDK 6.0 or above.

===3. Install CIL (C intermedia language)===
Note that: before continuing, you need to make sure you have installed OCaml language compiler. OCaml can be downloaded from http://caml.inria.fr/ocaml/. After downloading and unpacking the source distribution, in the ocaml directory, do:
  {{{
./configure
make world
make opt
make install
  }}}

Before building Linux kernel image, you need to setup and install cil in your Linux machine, which is used to process GNU C extension options when compiling Linux kernel.
  
Use the following command to check it out and compile, setup it.
  {{{
svn checkout http://tmlinux.googlecode.com/svn/trunk/cil
cd cil/
./configure
make  
export PATH=$PATH:/home/guohr/worktest/cil/obj/x86_LINUX/
  }}}

To validate the environment, type the following command and you will get the following message:
{{{
guohr@ghr-notebook-01:~/worktest/cil> cilly.asm.exe

Error: No arguments for CIL

Fatal error: exception Errormsg.Error
}}}

==Build Linux Kernel==
===1. checkout Linux kernel of tmlinux and setup environment===
checkout Linux kernel of tmlinux using the following command (at *_/home/guohr/worktest/_*): 
{{{
git clone git://github.com/camelguo/linux-2.6-trimedia.git linux
}}}

and run setup.sh to setup the compilation enviroment using the following commands:
{{{
cd /home/guohr/worktest/linux/
export NDK=/opt/NXP/NDK6.0/
./setup.sh
}}}

the evironment NDK should be set to your NDK directory.

===2. Configure Linux kernel===
First configure the linux kernel using default configuration files by the following command (at *_/home/guohr/worktest/linux/_* directory).

*To compile kernel for PNX1500 simulator*
{{{
make sim1500_defconfig
}}}
*To compile kernel for PNX1005 simulator*
{{{
make sim1005_defconfig
}}}
*To compile kernel for MBE1500*
{{{
make mbe1500_defconfig
}}}

Then adjust the configuration if necessary by the following command
{{{
make menuconfig
}}}

===3. Build Linux kernel===
To build linux kernel image, use the following command at *_/home/guohr/worktest/linux_*:
{{{
make
}}}

After building kernel, the `TMLinux-pnx1500-*-el.out` at _/home/guohr/worktest/linux/arch/trimedia/boot/_ is the executable Linux kernel image.

==Build uClibc and generate sysroot==
===1. Checkout sysroots and uClibc===
Checkout sysroots and uClibc using the following commands:
{{{
svn checkout http://tmlinux.googlecode.com/svn/trunk/sysroots
svn checkout http://tmlinux.googlecode.com/svn/trunk/uClibc
}}}

===2. Setup TCS for tmlinux build environment===
To create the whole TCS environment for building tmlinux uClibc and applications, you need to goto *_sysroots/sysroots/tcs/5.1.0_* and then use the following command:
{{{
cd /home/guohr/worktest/sysroots/tcs/5.1.0
TCS=/opt/NXP/TCS510 ./creat-tcs.sh
}}}
Please set TCS using your TCS installation path (In the above example, it is *_/opt/NXP/TCS510_*).

===3. Configure, build and install uClibc===
To build uClibc, you need to set the following configuration options correctly using the following command:
{{{
make menuconfig
}}}

====TCS include search path====
{{{
Target Architecture Features and Options -> tmcc compiler include search path
}}}
In this example, it is *_/home/guohr/worktest/sysroots/tcs/5.1.0_*

====Linux location====
{{{
Target Architecture Features and Options -> Linux Kernel header location
}}}
In this example, it is *_/home/guohr/worktest/linux_*

====uClibc installation directories====
{{{
Libary Installation Options -> uClibc runtime library directory
}}}
for pnx1500 simulator, it is *_/home/guohr/worktest/sysroots/pnx1500_ttisim_uclibc/sysroot_*; for pnx1005 simulator, it is *_/home/guohr/worktest/sysroots/pnx1005_ttisim_uclibc/sysroot_*; for pnx1500 standalone board, it is *_/home/guohr/worktest/sysroots/pnx1500_nohost_uclibc/sysroot_*;
{{{
Libary Installation Options -> uClibc development environment directory
}}}
for pnx1500 simulator, it is *_/home/guohr/worktest/sysroots/pnx1500_ttisim_uclibc/sysroot/usr_*; for pnx1005 simulator, it is *_/home/guohr/worktest/sysroots/pnx1005_ttisim_uclibc/sysroot/usr_*; for pnx1500 standalone board, it is *_/home/guohr/worktest/sysroots/pnx1500_nohost_uclibc/sysroot/usr_*;

Build and install uClibc using the following commands:
{{{
make 
make install
}}}


After installing uClibc, it is the time to deliver sysroots to application developers:
For how to build applications, please refer ApplicationDeveloperGettingStart;
For how to build busybox, please refer BusyboxGuide.

==Generate target root filesystem==
The target root filesystem is formed by a set of basic files (device node files and system configuration files) and lots of optional software package. This section describes how to form the target root filesystem for tmlinux.

===1. Install the basic files for the filesystem===
In SVN repository, there is a package call *filesystem*, which contains the basic files for target root filesystem of tmlinux. 

First, check it out from svn (suppose the directory of *filesystem* is *_/home/guohr/workdir/tmlinux/filesystem_*):
{{{
cd /home/guohr/workdir/tmlinux/
svn co http://tmlinux.googlecode.com/svn/trunk/filesystem
}}}
Second, install it to the target root filesystem directory (Let suppose the directory *_/home/guohr/workdir/tmlinux/export_* contains the whole content of the target root filesystem):
{{{
mkdir /home/guohr/workdir/tmlinux/export/
cd /home/guohr/workdir/tmlinux/filesystem/
vi Makefile
}}}

And then, set *_TARGET_ROOTFS=/home/guohr/workdir/tmlinux/export/_*. At directory *_/home/guohr/workdir/tmlinux/filesystem/_*
{{{
make
}}}


Now the basic files should be installed into the target root filesystem (*_/home/guohr/workdir/tmlinux/export_*)

===2. Install busybox for the filesystem===
BusyBox combines tiny versions of many common UNIX utilities into a single small executable. It is optional for the target root filesystem, but you are well advised to install it into target root fs.
To Build it, please refer BusyboxGuide. To install it, you need to set
{{{
Busybox Settings -> Installation Options -> Busybox installation prefix
}}}
to the target root filesystem directory, in the above example, it is *_/home/guohr/workdir/tmlinux/export_*. And then type *make install*.

===3. pack the target root filesystem and deliver it to application developer===
After install your software package for the target root filesystem, it is the time to deliver it to application developers, so that they can boot the whole linux system using it. 

To pack the target root filesystem, please use the following commands:
{{{
tar -C /home/guohr/workdir/tmlinux/export -cpf - . | bzip2 -9f > trimedia-uclibc_small-small-dist.tar.bz2
}}}
Above, the *_/home/guohr/workdir/tmlinux/export_* is the target root filesystem directory, the *_trimedia-uclibc_small-small-dist.tar.bz2_* contains the whole target root fs.

The application developers should unpack it using the following commands:
{{{
tar xvfjp trimedia-uclibc_small-small-dist.tar.bz2 -C /home/guohr/export 
}}}
Above, the *_/home/guohr/export_* is the directory which contains the target root filesystem content.

=references=

For more information about booting linux on trimedia, please refer BootingLinuxOnTriMedia.